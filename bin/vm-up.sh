#!/bin/bash

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
source $CURRENT_DIR/utils/constants.sh
source $CURRENT_DIR/utils/error_exit.sh

function remove_stoppped_container(){
  if [ "$(docker ps -aq -f status=exited -f name=$DNS_CONTAINER_NAME)" ]; then
    docker rm $DNS_CONTAINER_NAME &> /dev/null || error_exit "Unable to remove $DNS_CONTAINER_NAME container"
  fi
}

# This spins up a dnsmasq container so we don't have to manually update host files
function set_up_dnsmasq {
  echo "*** Setting up a dockerised DNS resolver..."

  remove_stoppped_container

  if [ "$(docker ps -q -f name=$DNS_CONTAINER_NAME)" ]; then
    docker stop $DNS_CONTAINER_NAME &> /dev/null || error_exit "Unable to stop $DNS_CONTAINER_NAME container"
    remove_stoppped_container
  fi

  # create the dnsmasq container
  docker run -d --name $DNS_CONTAINER_NAME -p $DNS_PORT:53/tcp -p $DNS_PORT:53/udp --cap-add=NET_ADMIN andyshinn/dnsmasq:2.78 --address=/$DOMAIN/127.0.0.1 &> /dev/null || error_exit "Unable to create $DNS_CONTAINER_NAME"

  docker ps -f name=$DNS_CONTAINER_NAME
  echo "---"
}

function create_resolver_file {
  echo "*** Checking resolver file..."

  # Make the directory
  sudo mkdir -p $RESOLVER_DIR || error_exit "Unable to create $RESOLVER_DIR"

  # Create file if not existed
  if [ ! -e $RESOLVER_FILE ]; then 
    sudo sh -c "echo '# This is auto-generated. Do NOT edit this file\nnameserver 127.0.0.1 \nport 53535' >> $RESOLVER_FILE" || error_exit "Unable to create $RESOLVER_FILE"  
    echo "Resolver created: $RESOLVER_FILE"
  fi
  echo "---"
}

set_up_dnsmasq
create_resolver_file