#!/bin/bash

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
source $CURRENT_DIR/utils/constants.sh
source $CURRENT_DIR/utils/error_exit.sh

function start_docker_machine(){
  docker-machine start $CORE_CMD_NAME
  echo ""
}

function docker_machine_env(){
  eval $(docker-machine env $CORE_CMD_NAME)
  echo "eval $(docker-machine env $CORE_CMD_NAME)"
  echo ""
}

function remove_stoppped_container(){
  if [ "$(docker ps -aq -f status=exited -f name=$DNS_CONTAINER_NAME)" ]; then
    docker rm $DNS_CONTAINER_NAME &> /dev/null || error_exit "Unable to remove $DNS_CONTAINER_NAME container"
  fi
}

# This spins up a dnsmasq container so we don't have to manually update host files
function set_up_dnsmasq {
  local DOCKER_MACHINE_IP="$(docker-machine ip ${CORE_CMD_NAME})"

  echo "*** Setting up a dockerised DNS resolver..."
  echo ""
  echo "-> Docker machine IP: $DOCKER_MACHINE_IP"
  echo "-> Docker machine name: $CORE_CMD_NAME"
  echo "-> DNS port: $DNS_PORT"
  echo ""

  remove_stoppped_container

  if [ "$(docker ps -q -f name=$DNS_CONTAINER_NAME)" ]; then
    docker stop $DNS_CONTAINER_NAME &> /dev/null || error_exit "Unable to stop $DNS_CONTAINER_NAME container"
    remove_stoppped_container
  fi

  # create the dnsmasq container
  docker run -d --name $DNS_CONTAINER_NAME -p $DNS_PORT:53/tcp -p $DNS_PORT:53/udp --cap-add=NET_ADMIN andyshinn/dnsmasq:2.78 --address=/$TOP_LEVEL_DOMAIN/$DOCKER_MACHINE_IP &> /dev/null || error_exit "Unable to create $DNS_CONTAINER_NAME"

  docker ps -f name=$DNS_CONTAINER_NAME
  echo ""
  echo "---"
}

function create_resolver_file {
  local DOCKER_MACHINE_IP="$(docker-machine ip ${CORE_CMD_NAME})"

  echo "*** Checking resolver file..."
  echo ""

  # Make the directory
  if [ ! -e $RESOLVER_DIR ]; then 
    sudo mkdir -p $RESOLVER_DIR || error_exit "Unable to create $RESOLVER_DIR"
    echo "Created new directory $RESOLVER_DIR"
    echo ""
  fi

  if [ -e $RESOLVER_FILE ]; then 
    echo "-> Removing old resolver file $RESOLVER_FILE ..."
    sudo rm $RESOLVER_FILE
    echo ""
  fi
  

  echo "-> Creating new resolve file $RESOLVER_FILE ..."
  sudo sh -c "echo '# This is auto-generated. Do NOT edit this file\nnameserver $DOCKER_MACHINE_IP \nport $DNS_PORT' >> $RESOLVER_FILE" || error_exit "Unable to create $RESOLVER_FILE"  
  echo "Resolver created: $RESOLVER_FILE"
  echo ""
  echo "---"
}

function increase_watchers {
  local cmd_increase_watchers="docker-machine ssh $CORE_CMD_NAME 'echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p'"
  echo "*** Increasing IO Notify watch limit on docker machine"
  echo ""
  echo $cmd_increase_watchers
  eval $cmd_increase_watchers
  echo ""
  echo "---"
}

start_docker_machine
docker_machine_env
set_up_dnsmasq
create_resolver_file
increase_watchers