version: '3.7'

services:
  main:
    image: main/dev-backend:latest
    command: nx serve main --port=${MAIN_SERVICE_PORT}
    volumes:
      - .:/usr/src/app/
      - /usr/src/app/node_modules
    networks:
      - vm

  database:
    image: mysql:8.0
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PORT=${MYSQL_PORT}
    volumes:
      - database_data:/var/lib/mysql
    expose:
      - ${MYSQL_PORT}
    ports:
      - ${MYSQL_PORT}:${MYSQL_PORT}
    networks:
      - vm

  reverse-proxy:
    build:
      context: .
      dockerfile: dev-tools/reverse-proxy/Dockerfile
    tty: true
    ports:
      - 80:80
      - 443:443
    depends_on:
      - main
      - dnsmasq
    environment:
      PRIMARY_DOMAIN: ${PRIMARY_DOMAIN}
      MAIN_SERVICE_NAME: ${MAIN_SERVICE_NAME}
      MAIN_SERVICE_PORT: ${MAIN_SERVICE_PORT}
    volumes:
      - ./dev-tools/reverse-proxy/templates:/etc/nginx/templates
    networks:
      - vm

  dnsmasq:
    image: 4km3/dnsmasq:2.85-r2-alpine-3.14
    ports:
      - 53535:53/tcp
      - 53535:53/udp
    cap_add: ['NET_ADMIN']
    volumes:
      - ./dev-tools/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      - vm

volumes:
  database_data:

networks:
  vm:
