version: '3'

services: 
  # Set up client container
  client:
    build: ./client
    ports:
      - ${CLIENT_PORT}:${CLIENT_PORT}
    environment:
      GRAPHQL_END_POINT: ${GRAPHQL_END_POINT}
      BIT_NPM_TOKEN: ${BIT_NPM_TOKEN}
    volumes:
      - ./client/public:/srv/app/client/public
      - ./client/src:/srv/app/client/src
    links:
      - graphql

  # Set up server container
  graphql:
    build: 
      context: ./graphql
      args:
        GRAPHQL_CONTAINER_PATH: ${GRAPHQL_CONTAINER_PATH}
    ports:
      - ${GRAPHQL_PORT}:${GRAPHQL_PORT}
    environment:
      PRISMA_ENDPOINT: ${PRISMA_ENDPOINT}
      SERVER_NAME: ${SERVER_NAME}
      JWT_SECRET: ${JWT_SECRET}
      BIT_NPM_TOKEN: ${BIT_NPM_TOKEN}
    volumes:
      - ./graphql/src:${GRAPHQL_CONTAINER_PATH}/src
    depends_on:
      - prisma

  # Set up load balancer container
  reverse-proxy:
    build: 
      context: ./reverse-proxy
      args:
        REVERSE_PROXY_CONTAINER_CONFIG_PATH: ${REVERSE_PROXY_CONTAINER_CONFIG_PATH}
    tty: true
    links:
        - client
        - graphql
    environment:
      REVERSE_PROXY_SERVER_NAME: ${REVERSE_PROXY_SERVER_NAME}
      REVERSE_PROXY_PORT: ${REVERSE_PROXY_PORT}
      CLIENT_SERVICE_NAME: ${CLIENT_SERVICE_NAME}
      CLIENT_PORT: ${CLIENT_PORT}
      CLIENT_URL_PATH: ${CLIENT_URL_PATH}
      GRAPHQL_SERVICE_NAME: ${GRAPHQL_SERVICE_NAME}
      GRAPHQL_PORT: ${GRAPHQL_PORT}
      GRAPHQL_URL_PATH: ${GRAPHQL_URL_PATH}
    ports:
        - 80:${REVERSE_PROXY_PORT}

  # Set up database server
  database:
    image: mysql:5.7
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PORT=${MYSQL_PORT}
    volumes:
      - database:/var/lib/mysql
    expose: 
      - ${MYSQL_PORT}
    ports:
      - ${MYSQL_PORT}:${MYSQL_PORT}

  # Set up prisma client
  prisma:
    image: prismagraphql/prisma:1.22
    restart: always
    ports:
      - ${PRISMA_PORT}:${PRISMA_PORT}
    environment:
      PRISMA_CONFIG: |
        port: ${PRISMA_PORT}
        databases:
          default:
            connector: mysql
            host: ${DATABASE_SERVICE_NAME}
            port: ${MYSQL_PORT}
            user: root
            password: ${MYSQL_ROOT_PASSWORD}
            migrations: true

volumes:
  database: