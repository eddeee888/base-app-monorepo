version: "3.7"

services:
  spa:
    image: bam/dev:latest
    command: nx serve spa --host 0.0.0.0 # Ensure Vite dev server can take Docker traffic with --host flag
    environment:
      DEV_SERVER_PORT: ${SPA_PORT}
      DEV_HMR_PORT: 443
      CI: "true" # Ensure Vite dev server do not immediately send 0 status in container
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    networks:
      - vm

  graph:
    build:
      context: .
      dockerfile: apps/graph/Dockerfile
      args:
        schema_flag: "--schema=./apps/graph/src/prisma/schema.prisma"
        prisma_database_url: ${PRISMA_DATABASE_URL}
        prisma_binary_target: ${PRISMA_BINARY_TARGET}
    command: nx serve graph
    environment:
      PORT: ${GRAPH_PORT}
      PRISMA_DATABASE_URL: ${PRISMA_DATABASE_URL}
      PRISMA_BINARY_TARGET: ${PRISMA_BINARY_TARGET}
    volumes:
      - .:/usr/src/app/
      - /usr/src/app/node_modules
    networks:
      - vm

  marketing:
    image: bam/dev:latest
    command: nx serve marketing --port=${MARKETING_PORT}
    volumes:
      - .:/usr/src/app/
      - /usr/src/app/node_modules
    networks:
      - vm

  database:
    image: mysql:8.0
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PORT=${MYSQL_PORT}
    volumes:
      - database_data:/var/lib/mysql
    expose:
      - ${MYSQL_PORT}
    ports:
      - ${MYSQL_PORT}:${MYSQL_PORT}
    networks:
      - vm

  reverse-proxy:
    build:
      context: .
      dockerfile: dev-services/reverse-proxy/Dockerfile
    tty: true
    ports:
      - 80:80
      - 443:443
    depends_on:
      - spa
      - graph
      - marketing
      - dnsmasq
    environment:
      PRIMARY_DOMAIN: ${PRIMARY_DOMAIN}
      SPA_SERVICE_NAME: ${SPA_SERVICE_NAME}
      SPA_PORT: ${SPA_PORT}
      GRAPH_SERVICE_NAME: ${GRAPH_SERVICE_NAME}
      GRAPH_PORT: ${GRAPH_PORT}
      MARKETING_SERVICE_NAME: ${MARKETING_SERVICE_NAME}
      MARKETING_PORT: ${MARKETING_PORT}
    volumes:
      - ./dev-services/reverse-proxy/templates:/etc/nginx/templates
    networks:
      vm:
        aliases:
          - ${PRIMARY_DOMAIN}

  dnsmasq:
    image: 4km3/dnsmasq:2.85-r2-alpine-3.14
    ports:
      - 53535:53/tcp
      - 53535:53/udp
    cap_add: ["NET_ADMIN"]
    volumes:
      - ./dev-services/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf
    networks:
      - vm

volumes:
  database_data:

networks:
  vm:
